(function(app){app.events.on('app:init',function(){app.plugins.register('FocusDrawer',['field'],{focusEnabled:false,validFocusLicenses:['SUGAR_SELL','SUGAR_SERVE'],onAttach:function(component){component.on('render',function(){this.focusEnabled=this.checkFocusAvailability();if(this.focusEnabled){this.initFocusIcon();}});},checkFocusAvailability:function(){var focusDrawerIsEnabled=app.utils.isTruthy(app.config.enableLinkToDrawer);var userHasValidFocusLicense=!_.isEmpty(_.intersection(this.validFocusLicenses,app.user.get('licenses')));var fieldIsValid=_.isFunction(this.getFocusContextModule)&&_.isFunction(this.getFocusContextModelId);var module=app.metadata.getModule(this.getFocusContextModule());var moduleIsNotBwc=!(module&&app.utils.isTruthy(module.isBwcEnabled));var moduleHasFocusDashboard=module&&app.utils.isTruthy(module.hasFocusDashboard);var moduleIsValid=moduleIsNotBwc&&moduleHasFocusDashboard;var focusDrawerComponentExists=this.getFocusDrawer();return focusDrawerIsEnabled&&userHasValidFocusLicense&&fieldIsValid&&moduleIsValid&&focusDrawerComponentExists;},initFocusIcon:function(){var relateFieldContainer=this.$el.find('.relate-field-container');var focusIconContainer=relateFieldContainer.find('.focus-icon-container');var isContainerHidden=focusIconContainer.hasClass('hide');if(isContainerHidden&&this.value){focusIconContainer.toggleClass('hide');var focusIcon=focusIconContainer.find('.focus-icon');focusIcon.click(_.bind(this.handleFocusClick,this));}},handleFocusClick:function(){if(this.focusEnabled){this.openFocusDrawer(this.getFocusContext());}},getFocusContext:function(){return{layout:'row-model-data',context:{layout:'focus',module:_.isFunction(this.getFocusContextModule)?this.getFocusContextModule():'',modelId:_.isFunction(this.getFocusContextModelId)?this.getFocusContextModelId():''}};},openFocusDrawer:function(context){var focusDrawer=this.getFocusDrawer();if(focusDrawer){var drawerIsOpen=focusDrawer.isOpen();var drawerContext=focusDrawer.currentContextDef;if(drawerIsOpen&&_.isEqual(context,drawerContext)){return;}
focusDrawer.open(context);}},getFocusDrawer:function(){if(!this.focusDrawer){var currLayout=this.view.layout;while(currLayout){this.focusDrawer=currLayout.getComponent('focus-drawer');if(!_.isEmpty(this.focusDrawer)){break;}
currLayout=currLayout.layout;}}
return this.focusDrawer;}});});})(SUGAR.App);